<!-- templates/admin/analytics/dashboard.html -->
{% extends 'base_apple.html' %}
{% load static %}

{% block title %}Панель администратора - Аналитика{% endblock %}

{% block content %}
<div class="analytics-dashboard">
  <h1>Панель аналитики</h1>
  
  <div class="stats-row">
    <div class="stat-card" data-modal="usersModal">
      <h3>Пользователи</h3>
      <div class="stat-value">{{ users_count }}</div>
      <div class="stat-trend {% if users_trend > 0 %}positive{% elif users_trend < 0 %}negative{% endif %}">
        {{ users_trend }}% за неделю
      </div>
    </div>
    
    <div class="stat-card" data-modal="conversationsModal">
      <h3>Диалоги</h3>
      <div class="stat-value">{{ conversations_count }}</div>
      <div class="stat-trend {% if conversations_trend > 0 %}positive{% elif conversations_trend < 0 %}negative{% endif %}">
        {{ conversations_trend }}% за неделю
      </div>
    </div>
    
    <div class="stat-card" data-modal="messagesModal">
      <h3>Сообщения</h3>
      <div class="stat-value">{{ messages_count }}</div>
      <div class="stat-trend {% if messages_trend > 0 %}positive{% elif messages_trend < 0 %}negative{% endif %}">
        {{ messages_trend }}% за неделю
      </div>
    </div>
    
    <div class="stat-card" data-modal="tasksModal">
      <h3>Задачи</h3>
      <div class="stat-value">{{ task_integrations_count }}</div>
      <div class="stat-trend {% if task_integrations_trend > 0 %}positive{% elif task_integrations_trend < 0 %}negative{% endif %}">
        {{ task_integrations_trend }}% за неделю
      </div>
    </div>
  </div>
  
  <!-- Модальные окна -->
  <div id="usersModal" class="apple-modal">
    <div class="apple-modal-content">
      <div class="apple-modal-header">
        <h2>Пользователи</h2>
        <button class="apple-modal-close" onclick="closeModal('usersModal')">&times;</button>
      </div>
      <div class="apple-modal-body">
        <div class="search-box">
          <input type="text" id="userSearch" placeholder="Поиск пользователей..." onkeyup="filterTable('userTable', 'userSearch')">
        </div>
        <table id="userTable" class="apple-table">
          <thead>
            <tr>
              <th>Имя пользователя</th>
              <th>Email</th>
              <th>Роль</th>
              <th>Дата регистрации</th>
              <th>Последняя активность</th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
            <tr>
              <td>{{ user.username }}</td>
              <td>{{ user.email }}</td>
              <td>{{ user.get_role_display }}</td>
              <td>{{ user.date_joined|date:"d.m.Y H:i" }}</td>
              <td>{{ user.last_active|date:"d.m.Y H:i" }}</td>
              <td>
                <a href="{% url 'chat:user_edit' user.id %}" class="apple-button">Редактировать</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="conversationsModal" class="apple-modal">
    <div class="apple-modal-content">
      <div class="apple-modal-header">
        <h2>Диалоги</h2>
        <button class="apple-modal-close" onclick="closeModal('conversationsModal')">&times;</button>
      </div>
      <div class="apple-modal-body">
        <div class="search-box">
          <input type="text" id="conversationSearch" placeholder="Поиск диалогов..." onkeyup="filterTable('conversationTable', 'conversationSearch')">
        </div>
        <table id="conversationTable" class="apple-table">
          <thead>
            <tr>
              <th>Название</th>
              <th>Пользователь</th>
              <th>Модель ИИ</th>
              <th>Дата создания</th>
              <th>Последнее обновление</th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody>
            {% for conversation in conversations %}
            <tr>
              <td>{{ conversation.title }}</td>
              <td>{{ conversation.user.username }}</td>
              <td>{{ conversation.ai_model.name }}</td>
              <td>{{ conversation.created_at|date:"d.m.Y H:i" }}</td>
              <td>{{ conversation.updated_at|date:"d.m.Y H:i" }}</td>
              <td>
                {% if conversation.id %}
                  <a href="{% url 'chat:conversation' conversation.id %}" class="apple-button">Просмотр</a>
                {% else %}
                  -
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="messagesModal" class="apple-modal">
    <div class="apple-modal-content">
      <div class="apple-modal-header">
        <h2>Сообщения</h2>
        <button class="apple-modal-close" onclick="closeModal('messagesModal')">&times;</button>
      </div>
      <div class="apple-modal-body">
        <div class="search-box">
          <input type="text" id="messageSearch" placeholder="Поиск сообщений..." onkeyup="filterTable('messageTable', 'messageSearch')">
        </div>
        <table id="messageTable" class="apple-table">
          <thead>
            <tr>
              <th>Диалог</th>
              <th>Роль</th>
              <th>Содержание</th>
              <th>Токены</th>
              <th>Дата</th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody>
            {% for message in messages %}
            <tr>
              <td>{{ message.conversation.title }}</td>
              <td>{{ message.get_role_display }}</td>
              <td>{{ message.content|truncatechars:50 }}</td>
              <td>{{ message.tokens }}</td>
              <td>{{ message.created_at|date:"d.m.Y H:i" }}</td>
              <td>
                {% if message.conversation and message.conversation.id %}
                  <a href="{% url 'chat:conversation' message.conversation.id %}" class="apple-button">Просмотр</a>
                {% else %}
                  -
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="tasksModal" class="apple-modal">
    <div class="apple-modal-content">
      <div class="apple-modal-header">
        <h2>Задачи</h2>
        <button class="apple-modal-close" onclick="closeModal('tasksModal')">&times;</button>
      </div>
      <div class="apple-modal-body">
        <div class="search-box">
          <input type="text" id="taskSearch" placeholder="Поиск задач..." onkeyup="filterTable('taskTable', 'taskSearch')">
        </div>
        <table id="taskTable" class="apple-table">
          <thead>
            <tr>
              <th>Название</th>
              <th>Проект</th>
              <th>Статус</th>
              <th>Исполнитель</th>
              <th>Срок</th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody>
            {% for task in tasks %}
            <tr>
              <td>{{ task.name }}</td>
              <td>{{ task.project_name }}</td>
              <td>{{ task.status }}</td>
              <td>{{ task.assignee }}</td>
              <td>{{ task.end_date|date:"d.m.Y" }}</td>
              <td>
                <a href="{% url 'chat:planfix_task_detail' task.task_id %}" class="apple-button">Просмотр</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Остальной контент -->
  <div class="chart-row">
    <div class="chart-container">
      <h3>Использование моделей ИИ</h3>
      <canvas id="modelUsageChart"></canvas>
    </div>
    
    <div class="chart-container">
      <h3>Ежедневная активность</h3>
      <canvas id="dailyActivityChart"></canvas>
    </div>
  </div>
  
  <div class="chart-row">
    <div class="chart-container">
      <h3>Использование токенов</h3>
      <canvas id="tokenUsageChart"></canvas>
    </div>
    
    <div class="chart-container">
      <h3>Топ пользователей</h3>
      <canvas id="topUsersChart"></canvas>
    </div>
  </div>
  
  <div class="table-container">
    <h3>Последние события</h3>
    <table class="analytics-table">
      <thead>
        <tr>
          <th>Тип события</th>
          <th>Пользователь</th>
          <th>Время</th>
          <th>Детали</th>
        </tr>
      </thead>
      <tbody>
        {% for event in recent_events %}
        <tr>
          <td>{{ event.event_type }}</td>
          <td>{{ event.user.username }}</td>
          <td>{{ event.timestamp }}</td>
          <td>
            {% if event.conversation and event.conversation.id %}
              <a href="{% url 'chat:conversation' event.conversation.id %}">
                {{ event.conversation.title }}
              </a>
            {% elif event.planfix_task_id %}
              <a href="{% url 'chat:planfix_task_detail' event.planfix_task_id %}">
                Задача: {{ event.planfix_task_id }}
              </a>
            {% else %}
              -
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  .analytics-dashboard {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
  }

  .stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .stat-card {
    background-color: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
    padding: 20px;
    border: 1px solid rgba(255, 255, 255, 0.7);
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
  }

  .stat-card h3 {
    font-size: 16px;
    color: #6e6e73;
    margin: 0 0 10px;
  }

  .stat-value {
    font-size: 32px;
    font-weight: 600;
    color: #1d1d1f;
    margin-bottom: 8px;
  }

  .stat-trend {
    font-size: 14px;
  }

  .stat-trend.positive {
    color: #34c759;
  }

  .stat-trend.negative {
    color: #ff3b30;
  }

  /* Стили для графиков */
  .chart-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .chart-container {
    background-color: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
    padding: 24px;
    border: 1px solid rgba(255, 255, 255, 0.7);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .chart-container:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
  }

  .chart-container h3 {
    font-size: 18px;
    font-weight: 600;
    color: #1d1d1f;
    margin: 0 0 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .chart-container canvas {
    width: 100% !important;
    height: 300px !important;
  }

  /* Dark theme support for charts */
  body.dark-theme .chart-container {
    background-color: rgba(40, 40, 45, 0.9);
    border-color: rgba(255, 255, 255, 0.1);
  }

  body.dark-theme .chart-container h3 {
    color: #f5f5f7;
    border-bottom-color: rgba(255, 255, 255, 0.1);
  }

  /* Mobile Adaptation for charts */
  @media (max-width: 768px) {
    .chart-row {
      grid-template-columns: 1fr;
    }
    
    .chart-container {
      padding: 16px;
    }
    
    .chart-container canvas {
      height: 250px !important;
    }
  }

  /* Apple-style Modal */
  .apple-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 1000;
    display: none;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .apple-modal.show {
    opacity: 1;
  }

  .apple-modal-content {
    position: relative;
    width: 90%;
    max-width: 1200px;
    margin: 40px auto;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 14px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    transform: translateY(20px);
    transition: transform 0.3s ease;
    overflow: hidden;
  }

  .apple-modal.show .apple-modal-content {
    transform: translateY(0);
  }

  .apple-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .apple-modal-header h2 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
    color: #1d1d1f;
  }

  .apple-modal-close {
    background: none;
    border: none;
    padding: 8px;
    cursor: pointer;
    color: #6e6e73;
    border-radius: 8px;
    transition: background-color 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .apple-modal-close:hover {
    background-color: rgba(0, 0, 0, 0.1);
  }

  .apple-modal-body {
    padding: 24px;
    max-height: calc(90vh - 140px);
    overflow-y: auto;
  }

  .search-box {
    margin-bottom: 20px;
  }

  .search-box input {
    width: 100%;
    padding: 12px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    font-size: 15px;
    transition: all 0.2s ease;
  }

  .search-box input:focus {
    border-color: #0071e3;
    outline: none;
    box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
  }

  .apple-table {
    width: 100%;
    border-collapse: collapse;
  }

  .apple-table th,
  .apple-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .apple-table th {
    font-weight: 600;
    color: #6e6e73;
    background-color: rgba(0, 0, 0, 0.02);
  }

  .apple-table tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
  }

  .apple-button {
    display: inline-block;
    padding: 6px 12px;
    background-color: #0071e3;
    color: white;
    border-radius: 6px;
    text-decoration: none;
    font-size: 14px;
    transition: background-color 0.2s ease;
  }

  .apple-button:hover {
    background-color: #0077ed;
  }

  /* Dark theme support */
  body.dark-theme .apple-modal-content {
    background: rgba(40, 40, 45, 0.9);
  }

  body.dark-theme .apple-modal-header h2 {
    color: #f5f5f7;
  }

  body.dark-theme .apple-modal-close {
    color: #a1a1a6;
  }

  body.dark-theme .apple-modal-close:hover {
    background-color: rgba(255, 255, 255, 0.1);
  }

  body.dark-theme .search-box input {
    background-color: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.1);
    color: #ffffff;
  }

  body.dark-theme .apple-table th {
    background-color: rgba(255, 255, 255, 0.05);
    color: #8e8e93;
  }

  body.dark-theme .apple-table td {
    border-bottom-color: rgba(255, 255, 255, 0.1);
    color: #ffffff;
  }

  body.dark-theme .apple-table tr:hover {
    background-color: rgba(255, 255, 255, 0.05);
  }

  /* Mobile Adaptation */
  @media (max-width: 768px) {
    .apple-modal-content {
      width: 95%;
      margin: 20px auto;
    }
    
    .apple-modal-header,
    .apple-modal-body {
      padding: 16px;
    }
  }

  /* Стили для таблицы последних событий */
  .table-container {
    background-color: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
    padding: 24px;
    border: 1px solid rgba(255, 255, 255, 0.7);
    margin-bottom: 30px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .table-container:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
  }

  .table-container h3 {
    font-size: 18px;
    font-weight: 600;
    color: #1d1d1f;
    margin: 0 0 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .analytics-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }

  .analytics-table th {
    text-align: left;
    padding: 12px 16px;
    font-weight: 600;
    color: #6e6e73;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    background-color: rgba(0, 0, 0, 0.02);
  }

  .analytics-table td {
    padding: 12px 16px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    color: #1d1d1f;
  }

  .analytics-table tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
  }

  .analytics-table a {
    color: #0071e3;
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .analytics-table a:hover {
    color: #0077ed;
    text-decoration: underline;
  }

  /* Dark theme support for table */
  body.dark-theme .table-container {
    background-color: rgba(40, 40, 45, 0.9);
    border-color: rgba(255, 255, 255, 0.1);
  }

  body.dark-theme .table-container h3 {
    color: #f5f5f7;
    border-bottom-color: rgba(255, 255, 255, 0.1);
  }

  body.dark-theme .analytics-table th {
    color: #8e8e93;
    background-color: rgba(255, 255, 255, 0.05);
    border-bottom-color: rgba(255, 255, 255, 0.1);
  }

  body.dark-theme .analytics-table td {
    color: #f5f5f7;
    border-bottom-color: rgba(255, 255, 255, 0.1);
  }

  body.dark-theme .analytics-table tr:hover {
    background-color: rgba(255, 255, 255, 0.05);
  }

  body.dark-theme .analytics-table a {
    color: #0a84ff;
  }

  body.dark-theme .analytics-table a:hover {
    color: #409cff;
  }

  /* Mobile Adaptation for table */
  @media (max-width: 768px) {
    .table-container {
      padding: 16px;
      overflow-x: auto;
    }
    
    .analytics-table {
      font-size: 13px;
    }
    
    .analytics-table th,
    .analytics-table td {
      padding: 8px 12px;
    }
  }
</style>
{% endblock %}

{% block scripts %}
<!-- Скрипт для модальных окон -->
<script>
console.log('Modal script loaded');

// Функции для модальных окон
function showModal(modalId) {
  console.log('Attempting to show modal:', modalId);
  const modal = document.getElementById(modalId);
  console.log('Modal element:', modal);
  if (modal) {
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
    // Trigger animation
    setTimeout(() => {
      modal.classList.add('show');
    }, 10);
    console.log('Modal displayed successfully');
  } else {
    console.error('Modal element not found:', modalId);
  }
}

function closeModal(modalId) {
  console.log('Attempting to close modal:', modalId);
  const modal = document.getElementById(modalId);
  if (modal) {
    // Remove show class for animation
    modal.classList.remove('show');
    // Hide modal after animation
    setTimeout(() => {
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
    }, 300);
    console.log('Modal closed successfully');
  } else {
    console.error('Modal element not found for closing:', modalId);
  }
}

function filterTable(tableId, searchId) {
  console.log('Filtering table:', tableId);
  const table = document.getElementById(tableId);
  const search = document.getElementById(searchId);
  if (!table || !search) {
    console.error('Table or search input not found:', { tableId, searchId });
    return;
  }

  const filter = search.value.toLowerCase();
  const rows = table.getElementsByTagName('tr');
  console.log('Found rows:', rows.length);

  for (let i = 1; i < rows.length; i++) {
    const row = rows[i];
    const cells = row.getElementsByTagName('td');
    let found = false;

    for (let j = 0; j < cells.length; j++) {
      const cell = cells[j];
      if (cell.textContent.toLowerCase().indexOf(filter) > -1) {
        found = true;
        break;
      }
    }

    row.style.display = found ? '' : 'none';
  }
}

// Закрытие модального окна при клике вне его содержимого
window.onclick = function(event) {
  if (event.target.classList.contains('apple-modal')) {
    console.log('Clicked outside modal, closing:', event.target.id);
    event.target.classList.remove('show');
    setTimeout(() => {
      event.target.style.display = 'none';
      document.body.style.overflow = 'auto';
    }, 300);
  }
}

// Добавляем обработчики событий для карточек
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM Content Loaded');
  const statCards = document.querySelectorAll('.stat-card');
  console.log('Found stat cards:', statCards.length);
  
  statCards.forEach(card => {
    console.log('Adding click handler to card:', card.getAttribute('data-modal'));
    card.addEventListener('click', function() {
      console.log('Card clicked:', this.getAttribute('data-modal'));
      const modalId = this.getAttribute('data-modal');
      if (modalId) {
        showModal(modalId);
      }
    });
  });
});
</script>

<!-- Скрипт для графиков -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script defer>
console.log('Chart script loaded');
document.addEventListener('DOMContentLoaded', function() {
  console.log('Initializing charts');
  
  // Общие настройки для всех графиков
  Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif';
  Chart.defaults.color = '#6e6e73';
  Chart.defaults.plugins.legend.position = 'bottom';
  Chart.defaults.plugins.legend.labels.padding = 20;
  Chart.defaults.plugins.legend.labels.usePointStyle = true;
  Chart.defaults.plugins.legend.labels.pointStyle = 'circle';
  
  // Model Usage Chart
  const modelUsageCtx = document.getElementById('modelUsageChart').getContext('2d');
  new Chart(modelUsageCtx, {
    type: 'pie',
    data: {
      labels: {{ ai_models_labels|safe }},
      datasets: [{
        data: {{ ai_models_data|safe }},
        backgroundColor: [
          'rgba(0, 113, 227, 0.8)',  // Apple Blue
          'rgba(88, 86, 214, 0.8)',  // Apple Purple
          'rgba(255, 149, 0, 0.8)',  // Apple Orange
          'rgba(52, 199, 89, 0.8)',  // Apple Green
          'rgba(255, 59, 48, 0.8)'   // Apple Red
        ],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 20,
            font: {
              size: 12
            }
          }
        }
      }
    }
  });
  
  // Daily Activity Chart
  const dailyActivityCtx = document.getElementById('dailyActivityChart').getContext('2d');
  new Chart(dailyActivityCtx, {
    type: 'line',
    data: {
      labels: {{ activity_dates|safe }},
      datasets: [{
        label: 'Диалоги',
        data: {{ daily_conversations|safe }},
        borderColor: 'rgba(0, 113, 227, 0.8)',
        backgroundColor: 'rgba(0, 113, 227, 0.1)',
        tension: 0.4,
        fill: true
      }, {
        label: 'Сообщения',
        data: {{ daily_messages|safe }},
        borderColor: 'rgba(88, 86, 214, 0.8)',
        backgroundColor: 'rgba(88, 86, 214, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 20,
            font: {
              size: 12
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          grid: {
            display: false
          }
        }
      }
    }
  });
  
  // Token Usage Chart
  const tokenUsageCtx = document.getElementById('tokenUsageChart').getContext('2d');
  new Chart(tokenUsageCtx, {
    type: 'bar',
    data: {
      labels: {{ ai_models_labels|safe }},
      datasets: [{
        label: 'Использование токенов',
        data: {{ tokens_by_model|safe }},
        backgroundColor: [
          'rgba(0, 113, 227, 0.8)',  // Apple Blue
          'rgba(88, 86, 214, 0.8)',  // Apple Purple
          'rgba(255, 149, 0, 0.8)',  // Apple Orange
          'rgba(52, 199, 89, 0.8)',  // Apple Green
          'rgba(255, 59, 48, 0.8)'   // Apple Red
        ],
        borderRadius: 6,
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          grid: {
            display: false
          }
        }
      }
    }
  });
  
  // Top Users Chart
  const topUsersCtx = document.getElementById('topUsersChart').getContext('2d');
  new Chart(topUsersCtx, {
    type: 'bar',
    data: {
      labels: {{ top_users_labels|safe }},
      datasets: [{
        label: 'Отправлено сообщений',
        data: {{ top_users_data|safe }},
        backgroundColor: 'rgba(0, 113, 227, 0.8)',
        borderRadius: 6,
        borderWidth: 0
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        y: {
          grid: {
            display: false
          }
        }
      }
    }
  });
});
</script>
{% endblock %}