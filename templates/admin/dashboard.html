<!-- templates/admin/analytics/dashboard.html -->
{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/admin-analytics.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="analytics-dashboard">
  <h1>Analytics Dashboard</h1>
  
  <div class="stats-row">
    <div class="stat-card">
      <h3>Users</h3>
      <div class="stat-value">{{ users_count }}</div>
      <div class="stat-trend {% if users_trend > 0 %}positive{% elif users_trend < 0 %}negative{% endif %}">
        {{ users_trend }}% from last week
      </div>
    </div>
    
    <div class="stat-card">
      <h3>Conversations</h3>
      <div class="stat-value">{{ conversations_count }}</div>
      <div class="stat-trend {% if conversations_trend > 0 %}positive{% elif conversations_trend < 0 %}negative{% endif %}">
        {{ conversations_trend }}% from last week
      </div>
    </div>
    
    <div class="stat-card">
      <h3>Messages</h3>
      <div class="stat-value">{{ messages_count }}</div>
      <div class="stat-trend {% if messages_trend > 0 %}positive{% elif messages_trend < 0 %}negative{% endif %}">
        {{ messages_trend }}% from last week
      </div>
    </div>
    
    <div class="stat-card">
      <h3>Task Integrations</h3>
      <div class="stat-value">{{ task_integrations_count }}</div>
      <div class="stat-trend {% if task_integrations_trend > 0 %}positive{% elif task_integrations_trend < 0 %}negative{% endif %}">
        {{ task_integrations_trend }}% from last week
      </div>
    </div>
  </div>
  
  <div class="chart-row">
    <div class="chart-container">
      <h3>Conversations by AI Model</h3>
      <canvas id="modelUsageChart"></canvas>
    </div>
    
    <div class="chart-container">
      <h3>Daily Activity</h3>
      <canvas id="dailyActivityChart"></canvas>
    </div>
  </div>
  
  <div class="chart-row">
    <div class="chart-container">
      <h3>Token Usage by Model</h3>
      <canvas id="tokenUsageChart"></canvas>
    </div>
    
    <div class="chart-container">
      <h3>Top Users</h3>
      <canvas id="topUsersChart"></canvas>
    </div>
  </div>
  
  <div class="table-container">
    <h3>Recent Analytics Events</h3>
    <table class="analytics-table">
      <thead>
        <tr>
          <th>Event Type</th>
          <th>User</th>
          <th>Timestamp</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>
        {% for event in recent_events %}
        <tr>
          <td>{{ event.event_type }}</td>
          <td>{{ event.user.username }}</td>
          <td>{{ event.timestamp }}</td>
          <td>
            {% if event.conversation %}
              <a href="{% url 'admin:chat_conversation_change' event.conversation.id %}">
                {{ event.conversation.title }}
              </a>
            {% elif event.planfix_task_id %}
              Task: {{ event.planfix_task_id }}
            {% else %}
              -
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  // Chart initialization scripts will go here
  document.addEventListener('DOMContentLoaded', function() {
    // Model Usage Chart
    const modelUsageCtx = document.getElementById('modelUsageChart').getContext('2d');
    new Chart(modelUsageCtx, {
      type: 'pie',
      data: {
        labels: {{ ai_models_labels|safe }},
        datasets: [{
          data: {{ ai_models_data }},
          backgroundColor: [
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 99, 132, 0.8)',
            'rgba(255, 206, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)',
            'rgba(153, 102, 255, 0.8)',
          ]
        }]
      }
    });
    
    // Daily Activity Chart
    const dailyActivityCtx = document.getElementById('dailyActivityChart').getContext('2d');
    new Chart(dailyActivityCtx, {
      type: 'line',
      data: {
        label: 'Conversations',
          data: {{ daily_conversations }},
          borderColor: 'rgba(54, 162, 235, 0.8)',
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
          tension: 0.4
        }, {
          label: 'Messages',
          data: {{ daily_messages }},
          borderColor: 'rgba(255, 99, 132, 0.8)',
          backgroundColor: 'rgba(255, 99, 132, 0.2)',
          tension: 0.4
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
    
    // Token Usage Chart
    const tokenUsageCtx = document.getElementById('tokenUsageChart').getContext('2d');
    new Chart(tokenUsageCtx, {
      type: 'bar',
      data: {
        labels: {{ ai_models_labels|safe }},
        datasets: [{
          label: 'Token Usage',
          data: {{ tokens_by_model }},
          backgroundColor: [
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 99, 132, 0.8)',
            'rgba(255, 206, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)',
            'rgba(153, 102, 255, 0.8)',
          ]
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
    
    // Top Users Chart
    const topUsersCtx = document.getElementById('topUsersChart').getContext('2d');
    new Chart(topUsersCtx, {
      type: 'horizontalBar',
      data: {
        labels: {{ top_users_labels|safe }},
        datasets: [{
          label: 'Messages Sent',
          data: {{ top_users_data }},
          backgroundColor: 'rgba(75, 192, 192, 0.8)',
        }]
      },
      options: {
        indexAxis: 'y',
        scales: {
          x: {
            beginAtZero: true
          }
        }
      }
    });
  });
</script>
{% endblock %}