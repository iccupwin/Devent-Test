{% extends 'base_apple.html' %}
{% load static %}

{% block title %}New Agent Conversation{% endblock %}

{% block extra_css %}
<style>
    .agent-sidebar {
        width: 280px;
        background-color: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-right: 1px solid rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .agent-status {
        padding: 16px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .agent-status-title {
        font-size: 14px;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 8px;
    }
    
    .agent-status-item {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        margin-bottom: 6px;
    }
    
    .agent-status-label {
        color: #6e6e73;
    }
    
    .agent-status-value {
        font-weight: 500;
        color: #1d1d1f;
    }
    
    .agent-status-value.warning {
        color: #ff9500;
    }
    
    .agent-status-value.danger {
        color: #ff3b30;
    }
    
    .agent-status-value.success {
        color: #34c759;
    }
    
    .refresh-link {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
        color: #0071e3;
        cursor: pointer;
        text-decoration: none;
    }
    
    .refresh-link:hover {
        text-decoration: underline;
    }
    
    .cache-status {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
        font-size: 12px;
    }
    
    .cache-status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }
    
    .cache-status-indicator.valid {
        background-color: #34c759;
    }
    
    .cache-status-indicator.invalid {
        background-color: #ff3b30;
    }
    
    .message-highlight {
        background-color: rgba(0, 113, 227, 0.1);
        padding: 2px 4px;
        border-radius: 4px;
        font-weight: 500;
    }
    
    /* Expand assistant messages to full width */
    .message.assistant {
        max-width: 100%;
    }
    
    /* Message content styling for better readability */
    .message-content {
        line-height: 1.6;
    }
    
    /* Suggestion chips */
    .suggestion-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 20px;
    }
    
    .suggestion-chip {
        background-color: rgba(0, 113, 227, 0.1);
        color: #0071e3;
        border: 1px solid rgba(0, 113, 227, 0.2);
        border-radius: 16px;
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .suggestion-chip:hover {
        background-color: rgba(0, 113, 227, 0.2);
        transform: translateY(-2px);
    }
    
    /* Dark theme adjustments */
    body.dark-theme .agent-sidebar {
        background-color: rgba(40, 40, 45, 0.7);
        border-right-color: rgba(255, 255, 255, 0.1);
    }
    
    body.dark-theme .agent-status {
        border-bottom-color: rgba(255, 255, 255, 0.1);
    }
    
    body.dark-theme .agent-status-title {
        color: #f5f5f7;
    }
    
    body.dark-theme .agent-status-label {
        color: #a1a1a6;
    }
    
    body.dark-theme .agent-status-value {
        color: #f5f5f7;
    }
    
    body.dark-theme .message-highlight {
        background-color: rgba(10, 132, 255, 0.2);
    }
    
    body.dark-theme .suggestion-chip {
        background-color: rgba(10, 132, 255, 0.2);
        color: #0a84ff;
        border-color: rgba(10, 132, 255, 0.3);
    }
    
    body.dark-theme .suggestion-chip:hover {
        background-color: rgba(10, 132, 255, 0.3);
    }

    .model-selector {
        margin: 20px 0 10px 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .model-select {
        padding: 8px 35px 8px 15px;
        border: 2px solid #0071e3;
        border-radius: 8px;
        background-color: white;
        color: #0071e3;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        min-width: 180px;
        appearance: none;
    }
    .model-select-arrow {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #0071e3;
        pointer-events: none;
        font-size: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div class="app-layout">
    <div class="agent-sidebar">
        <div class="agent-status">
            <div class="agent-status-title">Статистика Планфикса</div>
            
            <div class="agent-status-item">
                <span class="agent-status-label">Активные задачи</span>
                <span class="agent-status-value">{{ stats.active_tasks }}</span>
            </div>
            
            <div class="agent-status-item">
                <span class="agent-status-label">Просроченные задачи</span>
                <span class="agent-status-value {% if stats.overdue_tasks > 0 %}danger{% endif %}">{{ stats.overdue_tasks }}</span>
            </div>
            
            <div class="agent-status-item">
                <span class="agent-status-label">На этой неделе</span>
                <span class="agent-status-value {% if stats.tasks_due_this_week > 5 %}warning{% endif %}">{{ stats.tasks_due_this_week }}</span>
            </div>
            
            <div class="agent-status-item">
                <span class="agent-status-label">Коэффициент завершения</span>
                <span class="agent-status-value {% if stats.completion_rate > 75 %}success{% elif stats.completion_rate > 50 %}warning{% else %}danger{% endif %}">{{ stats.completion_rate|floatformat:1 }}%</span>
            </div>
            
            <div class="cache-status">
                <div class="cache-status-indicator {% if cache_valid %}valid{% else %}invalid{% endif %}"></div>
                <span>
                    Кэш: 
                    {% if cache_valid %}
                        Valid ({{ stats.cache_age_minutes|floatformat:1 }}m old)
                    {% else %}
                        Stale ({{ stats.cache_age_minutes|floatformat:1 }}m old)
                    {% endif %}
                </span>
            </div>
            
            <div style="margin-top: 8px;">
                <a href="#" id="refresh-cache-link" class="refresh-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M23 4v6h-6"></path>
                        <path d="M1 20v-6h6"></path>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                    </svg>
                    Обновить кэш
                </a>
            </div>
        </div>
        
        <button id="dashboardButton" class="new-chat-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
            </svg>
            Вернуться к панели
        </button>
        
        <div class="conversations-list">
            {% for conv in conversations %}
            <a href="{% url 'chat:agent_conversation' conversation_id=conv.id %}" class="conversation-item">
                {{ conv.title }}
            </a>
            {% endfor %}
        </div>
    </div>
    
    <div class="content">
        <div class="model-selector">
            <div style="position:relative;">
                <select id="aiModelSelect" class="model-select">
                    {% for model in ai_models %}
                    <option value="{{ model.id }}" {% if forloop.first %}selected{% endif %}>{{ model.name }}</option>
                    {% endfor %}
                </select>
                <div class="model-select-arrow">▼</div>
            </div>
            <span id="currentModelName" style="margin-left: 16px; color: #0071e3; font-weight: bold;">
                Текущая модель: {{ ai_models.0.name }}
            </span>
        </div>
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <div class="welcome-message">
                    <h1>Planfix AI Agent</h1>
                    <p>Я могу помочь вам разобраться в данных ПланФикса. Попробуйте задать вопросы о задачах, проектах, сроках и многом другом.</p>
                    
                    <div class="suggestion-chips">
                        <div class="suggestion-chip" data-query="Какие задачи просрочены?">Какие задачи просрочены?</div>
                        <div class="suggestion-chip" data-query="Покажите мне задания, которые нужно выполнить на этой неделе">Покажите мне задания, которые нужно выполнить на этой неделе</div>
                        <div class="suggestion-chip" data-query="Проекты с наиболее активными задачами">Проекты с наиболее активными задачами</div>
                        <div class="suggestion-chip" data-query="Каков текущий процент выполнения?">Текущий уровень завершения</div>
                        <div class="suggestion-chip" data-query="У кого больше всего заданий?">У кого больше всего заданий</div>
                        <div class="suggestion-chip" data-query="Каким задачам я должен отдать предпочтение сегодня?">Что я должен сделать приоритетным сегодня?</div>
                    </div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <form id="messageForm" class="message-form">
                    <textarea 
                        id="messageInput" 
                        class="message-input" 
                        placeholder="Задайте вопрос о данных Планфикс..."
                        rows="1"
                        autocomplete="off"
                    ></textarea>
                    <button type="submit" class="send-button">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const chatMessages = document.getElementById('chatMessages');
    const dashboardButton = document.getElementById('dashboardButton');
    const refreshCacheLink = document.getElementById('refresh-cache-link');
    const suggestionChips = document.querySelectorAll('.suggestion-chip');
    const modelSelect = document.getElementById('aiModelSelect');
    const label = document.getElementById('currentModelName');
    
    // Current conversation ID (null for new conversation)
    let currentConversationId = null;
    
    // Automatically adjust textarea height
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
    
    // Scroll chat to bottom
    function scrollToBottom() {
        if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }
    scrollToBottom();
    
    // Dashboard button handler
    if (dashboardButton) {
        dashboardButton.addEventListener('click', function() {
            window.location.href = '{% url "chat:agent_dashboard" %}';
        });
    }
    
    // Suggestion chips handler
    suggestionChips.forEach(chip => {
        chip.addEventListener('click', function() {
            const query = this.getAttribute('data-query');
            if (query) {
                // Set the query in the input field
                messageInput.value = query;
                
                // Submit the form
                messageForm.dispatchEvent(new Event('submit'));
            }
        });
    });
    
    // Refresh cache link handler
    if (refreshCacheLink) {
        refreshCacheLink.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Show loading state
            this.textContent = 'Refreshing...';
            
            // Call refresh API
            fetch('/api/agent/refresh-cache/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error refreshing cache');
                }
                return response.json();
            })
            .then(data => {
                // Show success message
                this.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg> Cache refreshed';
                
                // Add system message about cache refresh
                addMessageToChat('assistant', 'I\'ve refreshed the Planfix data cache. Now I\'m working with the latest information.');
                
                // Reset link text after 3 seconds
                setTimeout(() => {
                    this.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg> Refresh cache';
                }, 3000);
            })
            .catch(error => {
                // Show error message
                this.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg> Error refreshing';
                console.error('Error:', error);
                
                // Add system message about cache refresh error
                addMessageToChat('assistant', 'I encountered an error while trying to refresh the Planfix data cache. Please try again later or contact the administrator if the problem persists.');
                
                // Reset link text after 3 seconds
                setTimeout(() => {
                    this.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg> Refresh cache';
                }, 3000);
            });
        });
    }
    
    // Form submission handler
    if (messageForm) {
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const message = messageInput.value.trim();
            if (!message) return;
            
            // Add user message to chat
            addMessageToChat('user', message);
            
            // Clear input
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // Show typing indicator
            const typingIndicator = addTypingIndicator();
            
            // Send message to agent API
            sendMessageToAgent(message)
                .then(response => {
                    // Remove typing indicator
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }
                    
                    // Add agent response to chat
                    addMessageToChat('assistant', response.message);
                    
                    // Update conversation ID if new
                    if (response.conversation_id && !currentConversationId) {
                        currentConversationId = response.conversation_id;
                        
                        // Update URL without page reload
                        const newUrl = `/agent/conversation/${currentConversationId}/`;
                        window.history.pushState({}, '', newUrl);
                    }
                    
                    // Scroll to bottom
                    scrollToBottom();
                })
                .catch(error => {
                    console.error('Error:', error);
                    
                    // Remove typing indicator
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }
                    
                    // Show error message
                    addMessageToChat('assistant', 'Sorry, there was an error processing your request. Please try again later or contact the administrator if the problem persists.');
                    scrollToBottom();
                });
        });
    }
    
    // Add message to chat
    function addMessageToChat(role, content) {
        // Remove welcome message if present
        const welcomeMessage = document.querySelector('.welcome-message');
        if (welcomeMessage) {
            welcomeMessage.remove();
        }
        
        // Create message element
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', role);
        
        // Different structure based on role
        if (role === 'assistant') {
            messageElement.innerHTML = `
                <div class="assistant-avatar">A</div>
                <div class="message-content-wrapper">
                    <div class="message-role">Planfix Agent</div>
                    <div class="message-content">${formatMessageContent(content)}</div>
                </div>
            `;
        } else {
            messageElement.innerHTML = `
                <div class="message-role">You</div>
                <div class="message-content">${formatMessageContent(content)}</div>
            `;
        }
        
        // Add to DOM
        chatMessages.appendChild(messageElement);
        
        // Scroll into view
        scrollToBottom();
        
        return messageElement;
    }
    
    // Format message content
    function formatMessageContent(content) {
        // Escape HTML and preserve line breaks
        const escaped = escapeHtml(content);
        return escaped.replace(/\n/g, '<br>');
    }
    
    // Add typing indicator
    function addTypingIndicator() {
        const indicator = document.createElement('div');
        indicator.classList.add('typing-indicator');
        
        for (let i = 0; i < 3; i++) {
            const dot = document.createElement('div');
            dot.classList.add('typing-dot');
            indicator.appendChild(dot);
        }
        
        chatMessages.appendChild(indicator);
        scrollToBottom();
        
        return indicator;
    }
    
    // Send message to agent API
    async function sendMessageToAgent(message) {
        const payload = {
            message: message,
            conversation_id: currentConversationId
        };
        // Если это новая беседа, добавляем выбранную модель
        if (!currentConversationId) {
            const select = document.getElementById('aiModelSelect');
            if (select) {
                payload.model_id = select.value;
            }
        }
        const response = await fetch('/api/agent/message/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Network error');
        }
        
        return response.json();
    }
    
    // Escape HTML
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
    
    // Get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Здесь можно добавить обработчик выбора модели для новой беседы
    if (modelSelect && label) {
        modelSelect.addEventListener('change', function() {
            label.textContent = 'Текущая модель: ' + this.options[this.selectedIndex].text;
            // Если беседа уже создана, отправляем запрос на смену модели
            if (currentConversationId) {
                const selectedModelId = this.value;
                fetch(`/chat/conversation/${currentConversationId}/change-model/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        model_id: selectedModelId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // Можно обновить надпись или показать уведомление
                    if (data.success) {
                        label.textContent = 'Текущая модель: ' + modelSelect.options[modelSelect.selectedIndex].text;
                    }
                })
                .catch(error => console.error('Ошибка при смене модели:', error));
            }
        });
    }
});
</script>
{% endblock %}