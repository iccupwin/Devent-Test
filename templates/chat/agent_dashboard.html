{% extends 'base_apple.html' %}
{% load static %}

{% block title %}Planfix AI Agent Dashboard{% endblock %}

{% block extra_css %}
<style>
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background-color: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        padding: 24px;
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        border: 1px solid rgba(255, 255, 255, 0.7);
    }
    
    .stat-card:hover {
        transform: translateY(-6px) scale(1.01);
        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.12);
    }
    
    .stat-title {
        font-size: 14px;
        color: #6e6e73;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.02em;
    }
    
    .stat-value {
        font-size: 36px;
        font-weight: 700;
        color: #1d1d1f;
        margin-bottom: 8px;
    }
    
    .stat-value.success {
        color: #34c759;
    }
    
    .stat-value.warning {
        color: #ff9500;
    }
    
    .stat-value.danger {
        color: #ff3b30;
    }
    
    .stat-info {
        font-size: 14px;
        color: #6e6e73;
    }
    
    .welcome-section {
        background-color: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        padding: 30px;
        margin-bottom: 30px;
        border: 1px solid rgba(255, 255, 255, 0.7);
    }
    
    .welcome-title {
        font-size: 28px;
        font-weight: 700;
        color: #1d1d1f;
        margin-bottom: 16px;
    }
    
    .welcome-text {
        font-size: 16px;
        color: #6e6e73;
        line-height: 1.6;
        margin-bottom: 24px;
    }
    
    .refresh-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        background-color: #0071e3;
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        position: relative;
    }
    
    .refresh-button:hover {
        background-color: #0077ed;
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 113, 227, 0.4);
    }
    
    .refresh-icon-wrapper {
        position: relative;
        width: 20px;
        height: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .refresh-icon {
        position: absolute;
        width: 20px;
        height: 20px;
        transition: opacity 0.3s ease;
    }

    .refresh-spinner {
        position: absolute;
        width: 20px;
        height: 20px;
        opacity: 0;
        transition: opacity 0.3s ease;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }

    .refresh-spinner.visible {
        opacity: 1;
    }

    .refresh-icon.hidden {
        opacity: 0;
    }
    
    .start-conversation-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        background-color: #0071e3;
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
    }
    
    .start-conversation-button:hover {
        background-color: #0077ed;
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 113, 227, 0.4);
    }
    
    .cache-status {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 16px;
        font-size: 14px;
    }
    
    .cache-status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }
    
    .cache-status-indicator.valid {
        background-color: #34c759;
    }
    
    .cache-status-indicator.invalid {
        background-color: #ff3b30;
    }
    
    /* Dark theme adjustments */
    body.dark-theme .stat-card,
    body.dark-theme .welcome-section {
        background-color: rgba(40, 40, 45, 0.8);
        border-color: rgba(60, 60, 65, 0.5);
    }
    
    body.dark-theme .stat-title,
    body.dark-theme .stat-info,
    body.dark-theme .welcome-text {
        color: #a1a1a6;
    }
    
    body.dark-theme .stat-value,
    body.dark-theme .welcome-title {
        color: #f5f5f7;
    }
    
    body.dark-theme .stat-value.success {
        color: #30d158;
    }
    
    body.dark-theme .stat-value.warning {
        color: #ff9f0a;
    }
    
    body.dark-theme .stat-value.danger {
        color: #ff453a;
    }

    /* Стили для модального окна */
    #usersModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999999;
    }

    .modal-content {
        position: relative;
        background-color: #ffffff;
        margin: 50px auto;
        padding: 0;
        width: 90%;
        max-width: 1000px;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 24px;
        color: #1d1d1f;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #6e6e73;
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }

    .modal-body {
        padding: 20px;
    }

    .user-profile {
        display: flex;
        gap: 24px;
        padding: 24px;
    }

    .user-avatar {
        flex-shrink: 0;
    }

    .user-info {
        flex-grow: 1;
    }

    .user-stats {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid rgba(0, 0, 0, 0.08);
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .user-stats .stat-row {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 6px;
        margin-bottom: 2px;
        flex-wrap: wrap;
        width: 100%;
    }

    .user-stats .stat-label {
        font-size: 11px;
        color: #b0b0b5;
        margin-bottom: 0;
        min-width: 0;
        font-weight: 400;
        display: flex;
        align-items: center;
        gap: 3px;
        word-break: break-word;
        flex-shrink: 0;
    }

    .user-stats .stat-value {
        font-size: 13px;
        font-weight: 600;
        color: #222;
        margin-left: 2px;
        word-break: break-word;
        white-space: normal;
        flex: 1 1 0;
        max-width: 100%;
        overflow-wrap: anywhere;
        text-align: right;
    }

    .user-stats .stat-label svg {
        width: 13px;
        height: 13px;
        vertical-align: middle;
        color: #b0b0b5;
    }

    .user-info h3 {
        font-size: 14px;
    }

    .user-role {
        font-size: 11px;
    }

    .user-card {
        padding: 12px;
    }

    .employees-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        padding: 20px 0;
    }

    .employee-card {
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.06);
        border: 1px solid #e5e5e7;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .employee-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }

    .employee-avatar {
        width: 48px;
        height: 48px;
        background: #f5f5f7;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #0071e3;
        flex-shrink: 0;
    }

    .employee-info {
        flex: 1;
        min-width: 0; /* Для корректной работы text-overflow */
    }

    .employee-info h3 {
        margin: 0 0 2px 0;
        font-size: 15px;
        font-weight: 600;
        color: #1d1d1f;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .employee-role {
        margin: 0 0 8px 0;
        font-size: 12px;
        color: #86868b;
    }

    .employee-email {
        margin: 0;
        font-size: 14px;
        color: #0071e3;
    }

    /* Dark theme support for employees section */
    body.dark-theme .employee-card {
        background: #2c2c2e;
        border-color: #3a3a3c;
    }

    body.dark-theme .employee-avatar {
        background: #3a3a3c;
        color: #0a84ff;
    }

    body.dark-theme .employee-info h3 {
        color: #fff;
    }

    body.dark-theme .employee-role {
        color: #8e8e93;
    }

    body.dark-theme .employee-email {
        color: #0a84ff;
    }

    @media (max-width: 768px) {
        .employees-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Добавляем стили для статистики сотрудников */
    .employee-stats {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid rgba(0, 0, 0, 0.08);
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
    }

    .stat-row {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    .stat-label {
        font-size: 11px;
        color: #6e6e73;
        margin-bottom: 2px;
    }

    .stat-value {
        font-size: 13px;
        font-weight: 600;
    }

    .stat-value.success {
        color: #34c759;
    }

    .stat-value.danger {
        color: #ff3b30;
    }

    /* Dark theme support */
    body.dark-theme .employee-stats {
        border-top-color: rgba(255, 255, 255, 0.1);
    }

    body.dark-theme .stat-label {
        color: #8e8e93;
    }

    body.dark-theme .stat-value.success {
        color: #30d158;
    }

    body.dark-theme .stat-value.danger {
        color: #ff453a;
    }

    /* Стили для секции пользователей */
    .users-section {
        margin-top: 40px;
    }

    .users-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        padding: 20px 0;
    }

    .user-card {
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.06);
        border: 1px solid #e5e5e7;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .user-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        background: #f5f5f7;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #0071e3;
        flex-shrink: 0;
    }

    .user-info {
        flex: 1;
        min-width: 0;
    }

    .user-info h3 {
        margin: 0 0 2px 0;
        font-size: 15px;
        font-weight: 600;
        color: #1d1d1f;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .user-role {
        margin: 0 0 8px 0;
        font-size: 12px;
        color: #86868b;
    }

    .user-stats {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid rgba(0, 0, 0, 0.08);
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    /* Dark theme support for users section */
    body.dark-theme .user-card {
        background: #2c2c2e;
        border-color: #3a3a3c;
    }

    body.dark-theme .user-avatar {
        background: #3a3a3c;
        color: #0a84ff;
    }

    body.dark-theme .user-info h3 {
        color: #fff;
    }

    body.dark-theme .user-role {
        color: #8e8e93;
    }

    body.dark-theme .user-stats {
        border-top-color: rgba(255, 255, 255, 0.1);
    }

    @media (max-width: 768px) {
        .users-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Стили для бейджей ролей */
    .role-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
    }

    .role-badge.admin {
        background-color: #ff3b30;
        color: white;
    }

    .role-badge.staff {
        background-color: #0071e3;
        color: white;
    }

    .role-badge.user {
        background-color: #34c759;
        color: white;
    }

    /* Dark theme support for role badges */
    body.dark-theme .role-badge.admin {
        background-color: #ff453a;
    }

    body.dark-theme .role-badge.staff {
        background-color: #0a84ff;
    }

    body.dark-theme .role-badge.user {
        background-color: #30d158;
    }

    /* Общие стили для карточек */
    .employee-card,
    .user-card {
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.06);
        border: 1px solid #e5e5e7;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .employee-card:hover,
    .user-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }

    .employee-avatar,
    .user-avatar {
        width: 48px;
        height: 48px;
        background: #f5f5f7;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #0071e3;
        flex-shrink: 0;
    }

    .employee-info,
    .user-info {
        flex: 1;
        min-width: 0;
    }

    .employee-info h3,
    .user-info h3 {
        margin: 0 0 2px 0;
        font-size: 15px;
        font-weight: 600;
        color: #1d1d1f;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .employee-role,
    .user-role {
        margin: 0 0 8px 0;
        font-size: 12px;
        color: #86868b;
    }

    .employee-stats,
    .user-stats {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid rgba(0, 0, 0, 0.08);
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
    }

    .stat-row {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    .stat-label {
        font-size: 11px;
        color: #6e6e73;
        margin-bottom: 2px;
    }

    .stat-value {
        font-size: 13px;
        font-weight: 600;
    }

    /* Стили для бейджей ролей */
    .role-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
    }

    .role-badge.admin {
        background-color: #ff3b30;
        color: white;
    }

    .role-badge.staff {
        background-color: #0071e3;
        color: white;
    }

    .role-badge.user {
        background-color: #34c759;
        color: white;
    }

    /* Dark theme support */
    body.dark-theme .employee-card,
    body.dark-theme .user-card {
        background: #2c2c2e;
        border-color: #3a3a3c;
    }

    body.dark-theme .employee-avatar,
    body.dark-theme .user-avatar {
        background: #3a3a3c;
        color: #0a84ff;
    }

    body.dark-theme .employee-info h3,
    body.dark-theme .user-info h3 {
        color: #fff;
    }

    body.dark-theme .employee-role,
    body.dark-theme .user-role {
        color: #8e8e93;
    }

    body.dark-theme .employee-stats,
    body.dark-theme .user-stats {
        border-top-color: rgba(255, 255, 255, 0.1);
    }

    body.dark-theme .stat-label {
        color: #8e8e93;
    }

    body.dark-theme .role-badge.admin {
        background-color: #ff453a;
    }

    body.dark-theme .role-badge.staff {
        background-color: #0a84ff;
    }

    body.dark-theme .role-badge.user {
        background-color: #30d158;
    }

    @media (max-width: 768px) {
        .employees-grid,
        .users-grid {
            grid-template-columns: 1fr;
        }
    }

    .user-email {
        font-size: 12px;
        color: #86868b;
        margin: 0 0 4px 0;
        word-break: break-all;
        white-space: normal;
    }

    @media (max-width: 600px) {
        .user-stats .stat-row {
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
        }
        .user-stats .stat-value {
            text-align: left;
        }
    }

    /* Модальное окно для задач сотрудника */
    #employeeTasksModal {
        position: fixed;
        z-index: 9999;
        left: 0; top: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.25);
        display: flex; align-items: center; justify-content: center;
    }

    .modal-content {
        background: #fff;
        border-radius: 12px;
        padding: 24px 24px 16px 24px;
        min-width: 320px;
        max-width: 95vw;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0,0,0,0.18);
        position: relative;
    }

    .modal-close {
        position: absolute;
        right: 18px; top: 12px;
        font-size: 28px;
        color: #888;
        cursor: pointer;
        border: none;
        background: none;
    }

    .modal-loading {
        color: #888;
        text-align: center;
        padding: 24px 0;
    }

    .tasks-list {
        margin: 0; padding: 0; list-style: none;
    }

    .tasks-list li {
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .tasks-list li:last-child { border-bottom: none; }

    .task-title { font-weight: 600; }

    .task-status { font-size: 12px; color: #3377C3; margin-left: 8px; }

    .task-project { font-size: 12px; color: #888; margin-left: 8px; }

    body.dark-theme .modal-content { background: #232326; color: #fff; }

    body.dark-theme .modal-close { color: #aaa; }

    body.dark-theme .tasks-list li { border-bottom: 1px solid #333; }

    body.dark-theme .task-project { color: #aaa; }

    .tasks-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 14px;
    }
    .tasks-table th, .tasks-table td {
        padding: 8px 6px;
        border-bottom: 1px solid #f0f0f0;
        text-align: left;
        vertical-align: top;
    }
    .tasks-table th {
        color: #888;
        font-weight: 500;
        background: #fafbfc;
    }
    .tasks-table tr:last-child td {
        border-bottom: none;
    }
    .tasks-table td {
        color: #222;
    }
    body.dark-theme .tasks-table th {
        background: #232326;
        color: #aaa;
    }
    body.dark-theme .tasks-table td {
        color: #fff;
    }
    body.dark-theme .tasks-table tr td {
        border-bottom: 1px solid #333;
    }

    .status-badge {
        display: inline-block;
        padding: 2px 10px;
        border-radius: 10px;
        font-size: 12px;
        font-weight: 500;
        color: #fff;
        background: #888;
        white-space: nowrap;
    }
    .status-inprogress { background: #3377C3; }
    .status-done, .status-completed { background: #34c759; }
    .status-overdue { background: #ff3b30; }
    .status-waiting { background: #ff9500; }
    .status-other { background: #888; }

    body.dark-theme .status-badge { color: #fff; }

    /* Модальное окно для пользователя */
    #userInfoModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999999;
    }

    .modal-content {
        position: relative;
        background-color: #ffffff;
        margin: 50px auto;
        padding: 25px;
        width: 90%;
        max-width: 1000px;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 24px;
        color: #1d1d1f;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #6e6e73;
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }

    .modal-body {
        padding: 20px;
    }

    .user-modal-label {
        color: #888;
        font-size: 13px;
        margin-bottom: 2px;
        display: block;
    }
    .user-modal-value {
        font-size: 15px;
        font-weight: 500;
        margin-bottom: 10px;
        color: #222;
        word-break: break-all;
    }
    body.dark-theme .user-modal-label { color: #aaa; }
    body.dark-theme .user-modal-value { color: #fff; }

    #userInfoModal .modal-content {
        background: #fff;
        border-radius: 14px;
        padding: 32px 40px 24px 40px;
        min-width: 360px;
        max-width: 95vw;
        max-height: 20vh;
        width: auto;
        box-shadow: 0 8px 32px rgba(0,0,0,0.18);
        position: relative;
        display: inline-block;
    }
    @media (max-width: 500px) {
        #userInfoModal .modal-content {
            min-width: unset;
            width: 95vw;
            padding: 20px 8vw 16px 8vw;
        }
    }
    #userInfoModal .modal-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
    }
    #userInfoModal .modal-header h2 {
        margin: 0;
        font-size: 22px;
        font-weight: 700;
        color: #1d1d1f;
    }
    #userInfoModal .role-badge {
        margin-left: 0;
        font-size: 12px;
        padding: 2px 10px;
    }
    #userInfoModal .user-modal-email {
        font-size: 14px;
        color: #86868b;
        margin-bottom: 10px;
        word-break: break-all;
    }
    #userInfoModal .user-modal-dates {
        display: flex;
        gap: 18px;
        align-items: center;
        font-size: 13px;
        color: #888;
    }
    #userInfoModal .user-modal-dates svg {
        width: 15px;
        height: 15px;
        vertical-align: middle;
        margin-right: 3px;
        color: #b0b0b5;
    }
    body.dark-theme #userInfoModal .modal-content { background: #232326; color: #fff; }
    body.dark-theme #userInfoModal .user-modal-email { color: #aaa; }
    body.dark-theme #userInfoModal .user-modal-dates { color: #aaa; }

    .tasks-table th.name-col { width: 40%; }
    .tasks-table th.status-col, .tasks-table td.status-col { width: 170px; min-width: 90px; text-align: center; }
    .tasks-table th.project-col { width: 18%; }

    .tasks-table td.start-date { color: #3377C3; font-weight: 500; }
    .tasks-table td.end-date { color: #ff3b30; font-weight: 500; }
    body.dark-theme .tasks-table td.start-date { color: #409cff; }
    body.dark-theme .tasks-table td.end-date { color: #ff453a; }

    .tasks-table td.project-col {
        background: none !important;
        color: inherit;
        border-radius: 0;
        font-weight: 600;
        padding: 0 0 0 0;
        display: block;
        min-width: 70px;
        max-width: 180px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    body.dark-theme .tasks-table td.project-col {
        background: none !important;
        color: inherit;
        border-radius: 0;
        font-weight: 600;
        padding: 0 0 0 0;
        display: block;
        min-width: 70px;
        max-width: 180px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .refresh-icon-wrapper {
        display: inline-block;
        position: relative;
        width: 22px;
        height: 22px;
        vertical-align: middle;
        margin-right: 8px;
    }
    .refresh-icon-wrapper svg {
        position: absolute;
        left: 0; top: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="planfix-container">
    <div class="welcome-section">
        <h1 class="welcome-title">Добро пожаловать в Planfix AI Agent</h1>
        <p class="welcome-text">
            Ваш интеллектуальный помощник для работы с задачами Planfix. 
            Начните новый диалог или продолжите существующий разговор.
        </p>
        <div class="button-group">
            <a href="{% url 'chat:new_agent_conversation' %}" class="start-conversation-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                Начать новый диалог
            </a>
            <button id="refreshCacheBtn" class="refresh-button" type="button">
                <span class="refresh-icon-wrapper">
                    <svg class="refresh-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M23 4v6h-6"></path>
                        <path d="M1 20v-6h6"></path>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                    </svg>
                    <svg class="refresh-spinner" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-opacity="0.2"/>
                        <path d="M12 2a10 10 0 0 1 10 10"/>
                    </svg>
                </span>
                <span id="refreshBtnText">Обновить кэш</span>
            </button>
        </div>
        <span id="refreshCacheStatus" style="margin-left:12px;font-size:14px;color:#888;"></span>
        <div class="cache-status">
            <div class="cache-status-indicator {% if cache_valid %}valid{% else %}invalid{% endif %}"></div>
            <span>Статус кэша: {% if cache_valid %}Актуален{% else %}Требует обновления{% endif %}</span>
        </div>
    </div>

    <!-- Секция сотрудников -->
    <div class="welcome-section employees-section">
        <h1 class="welcome-title">Наша команда</h1>
        <p class="welcome-text">Познакомьтесь с нашими сотрудниками</p>
        
        <div class="employees-grid">
            {% for employee in employees %}
            <div class="employee-card" data-employee-id="{{ employee.id }}">
                <div class="employee-avatar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <div class="employee-info">
                    <h3>{{ employee.name }}</h3>
                    <p class="employee-role">{{ employee.role }}</p>
                    <div class="employee-stats">
                        <div class="stat-row">
                            <span class="stat-label">Активные</span>
                            <span class="stat-value {% if employee.overdue_tasks > 0 %}danger{% endif %}">{{ employee.active_tasks }}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Выполнено</span>
                            <span class="stat-value success">{{ employee.completed_tasks }}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Проекты</span>
                            <span class="stat-value">{{ employee.projects }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-title">Всего задач</div>
            <div class="stat-value">{{ stats.total_tasks }}</div>
            <div class="stat-info">Общее количество задач в Планфиксе</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-title">Активные задачи</div>
            <div class="stat-value">{{ stats.active_tasks }}</div>
            <div class="stat-info">Текущие задачи</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-title">Просроченные задания</div>
            <div class="stat-value {% if stats.overdue_tasks > 0 %}danger{% endif %}">{{ stats.overdue_tasks }}</div>
            <div class="stat-info">Просроченные задания</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-title">Завершенные задачи</div>
            <div class="stat-value success">{{ stats.completed_tasks }}</div>
            <div class="stat-info">Выполненые задачи</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-title">На этой неделе</div>
            <div class="stat-value {% if stats.tasks_due_this_week > 5 %}warning{% endif %}">{{ stats.tasks_due_this_week }}</div>
            <div class="stat-info">В течение следующих 7 дней</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-title">Всего проектов</div>
            <div class="stat-value">{{ stats.total_projects }}</div>
            <div class="stat-info">Количество действующих проектов</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-title">Показатель завершения</div>
            <div class="stat-value {% if stats.completion_rate > 75 %}success{% elif stats.completion_rate > 50 %}warning{% else %}danger{% endif %}">{{ stats.completion_rate|floatformat:1 }}%</div>
            <div class="stat-info">Процент выполненных заданий</div>
        </div>
    </div>
    
    <!-- Секция пользователей -->
    <div class="welcome-section users-section">
        <h1 class="welcome-title">Пользователи системы</h1>
        <p class="welcome-text">Зарегистрированные пользователи</p>
        
        <div class="users-grid">
            {% for user in users %}
            <div class="user-card">
                <div class="user-avatar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <div class="user-info">
                    <h3>{{ user.name }}</h3>
                    <p class="user-role">
                        {% if user.is_admin %}
                        <span class="role-badge admin">Администратор</span>
                        {% elif user.is_staff %}
                        <span class="role-badge staff">Сотрудник</span>
                        {% else %}
                        <span class="role-badge user">Пользователь</span>
                        {% endif %}
                    </p>
                    <p class="user-email">{{ user.email|default:"—" }}</p>
                    <div class="user-stats">
                        <div class="stat-row">
                            <span class="stat-label">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><rect x="3" y="4" width="18" height="18" rx="2" stroke-width="2"/><path d="M16 2v4M8 2v4M3 10h18" stroke-width="2"/></svg>
                                Регистрация
                            </span>
                            <span class="stat-value">{{ user.date_joined|date:"d.m.Y" }}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><circle cx="12" cy="12" r="10" stroke-width="2"/><path d="M12 6v6l4 2" stroke-width="2"/></svg>
                                Активность
                            </span>
                            <span class="stat-value">{{ user.last_active|date:"d.m.Y" }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Модальное окно пользователей -->
    <div id="usersModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Информация о пользователе</h2>
                <button class="modal-close" onclick="closeModal('usersModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="user-profile">
                    <div class="user-avatar">
                        <div id="modalUserAvatar" style="width: 80px; height: 80px; background-color: #0071e3; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 32px;">
                        </div>
                    </div>
                    <div class="user-info">
                        <h3 id="modalUserName" style="font-size: 24px; margin: 0 0 8px; color: #1d1d1f;"></h3>
                        <p id="modalUserEmail" style="color: #6e6e73; margin: 0 0 16px;"></p>
                        <div class="user-stats">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                                <div>
                                    <div style="font-size: 14px; color: #6e6e73;">Роль</div>
                                    <div id="modalUserRole" style="font-size: 16px; font-weight: 500; color: #1d1d1f;"></div>
                                </div>
                                <div>
                                    <div style="font-size: 14px; color: #6e6e73;">Дата регистрации</div>
                                    <div id="modalUserDateJoined" style="font-size: 16px; font-weight: 500; color: #1d1d1f;"></div>
                                </div>
                                <div>
                                    <div style="font-size: 14px; color: #6e6e73;">Последняя активность</div>
                                    <div id="modalUserLastActive" style="font-size: 16px; font-weight: 500; color: #1d1d1f;"></div>
                                </div>
                                <div>
                                    <div style="font-size: 14px; color: #6e6e73;">Активные задачи</div>
                                    <div id="modalUserActiveTasks" style="font-size: 16px; font-weight: 500; color: #1d1d1f;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для задач сотрудника -->
    <div id="employeeTasksModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="modal-close" onclick="closeEmployeeModal()">&times;</span>
            <h2 id="modalEmployeeName">Задачи сотрудника</h2>
            <div id="modalTasksList">
                <div class="modal-loading">Загрузка задач...</div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для пользователя -->
    <div id="userInfoModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="modal-close" onclick="closeUserModal()">&times;</span>
            <h2 id="modalUserName">Пользователь</h2>
            <div id="modalUserInfo">
                <div class="modal-loading">Загрузка...</div>
            </div>
        </div>
    </div>

    <div class="welcome-section">
        <h2 class="welcome-title" style="font-size: 24px;">Последние беседы</h2>
        
        <div class="conversations-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
            {% for conversation in conversations|slice:":6" %}
            <a href="{% url 'chat:agent_conversation' conversation_id=conversation.id %}" class="stat-card" style="text-decoration: none; display: block;">
                <div style="font-size: 18px; font-weight: 600; color: #1d1d1f; margin-bottom: 8px;">{{ conversation.title }}</div>
                <div style="font-size: 14px; color: #6e6e73;">{{ conversation.updated_at|date:"d F Y, H:i" }}</div>
            </a>
            {% empty %}
            <div class="stat-card" style="grid-column: 1 / -1;">
                <div style="text-align: center; padding: 20px;">
                    <p style="font-size: 16px; color: #6e6e73; margin-bottom: 16px;">У вас пока нет никаких бесед.</p>
                    <a href="{% url 'chat:new_agent_conversation' %}" class="start-conversation-button">Начните первую беседу</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const refreshButton = document.getElementById('refresh-cache-button');
    
    if (refreshButton) {
        refreshButton.addEventListener('click', function() {
            // Show loading state
            refreshButton.disabled = true;
            refreshButton.innerHTML = '<div class="loading-spinner"></div> Refreshing...';
            
            // Call refresh API
            fetch('/api/agent/refresh-cache/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error refreshing cache');
                }
                return response.json();
            })
            .then(data => {
                // Show success and reload page
                refreshButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg> Refresh complete!';
                
                // Reload the page after 1 second
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            })
            .catch(error => {
                // Show error
                refreshButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg> Error refreshing';
                refreshButton.disabled = false;
                console.error('Error:', error);
                
                // Set original text after 3 seconds
                setTimeout(() => {
                    refreshButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg> Refresh cache';
                }, 3000);
            });
        });
    }
    
    // Function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});

function openModal(modalId, userData) {
    console.log('Opening modal with data:', userData);
    const modal = document.getElementById(modalId);
    console.log('Modal element:', modal);
    
    if (userData && modal) {
        // Заполняем данные пользователя
        const avatar = document.getElementById('modalUserAvatar');
        const name = document.getElementById('modalUserName');
        const email = document.getElementById('modalUserEmail');
        const role = document.getElementById('modalUserRole');
        const dateJoined = document.getElementById('modalUserDateJoined');
        const lastActive = document.getElementById('modalUserLastActive');
        const activeTasks = document.getElementById('modalUserActiveTasks');

        console.log('Modal elements:', { avatar, name, email, role, dateJoined, lastActive, activeTasks });

        if (avatar) avatar.textContent = userData.name.charAt(0).toUpperCase();
        if (name) name.textContent = userData.name;
        if (email) email.textContent = userData.email;
        if (role) role.textContent = userData.role;
        if (dateJoined) dateJoined.textContent = new Date(userData.date_joined).toLocaleString('ru-RU');
        if (lastActive) lastActive.textContent = new Date(userData.last_active).toLocaleString('ru-RU');
        if (activeTasks) activeTasks.textContent = userData.active_tasks;

        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        console.log('Modal display style:', modal.style.display);
    } else {
        console.error('Modal or user data is missing:', { modalId, userData, modal });
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

function filterTable(tableId, searchId) {
    var input = document.getElementById(searchId);
    var filter = input.value.toUpperCase();
    var table = document.getElementById(tableId);
    var tr = table.getElementsByTagName("tr");

    for (var i = 1; i < tr.length; i++) {
        var found = false;
        var td = tr[i].getElementsByTagName("td");
        
        for (var j = 0; j < td.length; j++) {
            if (td[j].textContent.toUpperCase().indexOf(filter) > -1) {
                found = true;
                break;
            }
        }
        
        tr[i].style.display = found ? "" : "none";
    }
}

// Закрытие модального окна при клике вне его
window.onclick = function(event) {
    if (event.target.id === 'usersModal') {
        closeModal('usersModal');
    }
}

// Обновляем обработчик клика по карточке пользователя
document.addEventListener('DOMContentLoaded', function() {
    const userCards = document.querySelectorAll('.user-card');
    userCards.forEach(card => {
        card.addEventListener('click', function() {
            try {
                const userData = JSON.parse(this.dataset.user);
                openModal('usersModal', userData);
            } catch (error) {
                console.error('Error parsing user data:', error);
            }
        });
    });
});

// Открытие модального окна и загрузка задач
const employeeCards = document.querySelectorAll('.employee-card');
employeeCards.forEach(card => {
    card.addEventListener('click', function() {
        const employeeName = this.querySelector('.employee-info h3').textContent.trim();
        const employeeId = this.getAttribute('data-employee-id');
        openEmployeeModal(employeeName, employeeId);
    });
});

function statusClass(status) {
    if (!status) return 'status-other';
    const s = status.toLowerCase();
    if (s.includes('в работе') || s.includes('in progress')) return 'status-inprogress';
    if (s.includes('заверш') || s.includes('done') || s.includes('completed')) return 'status-done status-completed';
    if (s.includes('просроч') || s.includes('overdue')) return 'status-overdue';
    if (s.includes('ожид') || s.includes('wait')) return 'status-waiting';
    return 'status-other';
}

function openEmployeeModal(name, id) {
    document.getElementById('modalEmployeeName').textContent = `Задачи сотрудника: ${name}`;
    document.getElementById('employeeTasksModal').style.display = 'flex';
    const tasksListDiv = document.getElementById('modalTasksList');
    tasksListDiv.innerHTML = '<div class="modal-loading">Загрузка задач...</div>';

    // Получаем активные задачи
    fetch(`/employee-tasks/${encodeURIComponent(id)}/`)
        .then(resp => resp.json())
        .then(data => {
            const tasks = data.tasks || [];
            let html = '';
            if (tasks.length === 0) {
                html += '<div class="modal-loading">Нет активных задач</div>';
            } else {
                html += `<table class='tasks-table'>
                  <thead>
                    <tr>
                      <th class='name-col'>Название</th>
                      <th class='project-col'>Проект</th>
                      <th class='status-col'>Статус</th>
                      <th>Начало</th>
                      <th>Окончание</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${tasks.map(task => `
                      <tr>
                        <td>${task.name || '—'}</td>
                        <td class='project-col' style='color:${getProjectColor(task.project ? task.project.name : '')}'>${task.project ? task.project.name : '—'}</td>
                        <td class='status-col'><span class="status-badge ${statusClass(task.status ? task.status.name : '')}">${task.status ? task.status.name : '—'}</span></td>
                        <td class='start-date'>${task.startDateTime ? (task.startDateTime.date || '—') : '—'}</td>
                        <td class='end-date'>${task.endDateTime ? (task.endDateTime.date || '—') : '—'}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>`;
            }
            // Получаем завершённые задачи
            fetch(`/employee-completed-tasks/${encodeURIComponent(id)}/`)
                .then(resp2 => resp2.json())
                .then(data2 => {
                    const completed = data2.tasks || [];
                    if (completed.length > 0) {
                        html += `<h3 style='margin:24px 0 8px 0;font-size:17px;'>Завершённые задачи</h3>`;
                        html += `<table class='tasks-table'>
                          <thead>
                            <tr>
                              <th class='name-col'>Название</th>
                              <th class='project-col'>Проект</th>
                              <th class='status-col'>Статус</th>
                              <th>Начало</th>
                              <th>Окончание</th>
                            </tr>
                          </thead>
                          <tbody>
                            ${completed.map(task => `
                              <tr>
                                <td>${task.name || '—'}</td>
                                <td class='project-col' style='color:${getProjectColor(task.project ? task.project.name : '')}'>${task.project ? task.project.name : '—'}</td>
                                <td class='status-col'><span class="status-badge ${statusClass(task.status ? task.status.name : '')}">${task.status ? task.status.name : '—'}</span></td>
                                <td class='start-date'>${task.startDateTime ? (task.startDateTime.date || '—') : '—'}</td>
                                <td class='end-date'>${task.endDateTime ? (task.endDateTime.date || '—') : '—'}</td>
                              </tr>
                            `).join('')}
                          </tbody>
                        </table>`;
                    }
                    tasksListDiv.innerHTML = html;
                })
                .catch(() => {
                    tasksListDiv.innerHTML = html + '<div class="modal-loading">Ошибка загрузки завершённых задач</div>';
                });
        })
        .catch(() => {
            tasksListDiv.innerHTML = '<div class="modal-loading">Ошибка загрузки задач</div>';
        });
}

function closeEmployeeModal() {
    document.getElementById('employeeTasksModal').style.display = 'none';
}

// Добавляем обработчик для закрытия модального окна по клику на фон
const employeeModal = document.getElementById('employeeTasksModal');
if (employeeModal) {
  employeeModal.addEventListener('click', function(event) {
    if (event.target === this) {
      closeEmployeeModal();
    }
  });
}

// Открытие модального окна пользователя
const userCards = document.querySelectorAll('.user-card');
userCards.forEach(card => {
    card.addEventListener('click', function() {
        const name = this.querySelector('.user-info h3').textContent.trim();
        const email = this.querySelector('.user-email') ? this.querySelector('.user-email').textContent.trim() : '';
        const role = this.querySelector('.role-badge') ? this.querySelector('.role-badge').textContent.trim() : '';
        const reg = this.querySelector('.user-stats .stat-row:nth-child(1) .stat-value') ? this.querySelector('.user-stats .stat-row:nth-child(1) .stat-value').textContent.trim() : '';
        const act = this.querySelector('.user-stats .stat-row:nth-child(2) .stat-value') ? this.querySelector('.user-stats .stat-row:nth-child(2) .stat-value').textContent.trim() : '';
        openUserModal({name, email, role, reg, act});
    });
});

function openUserModal(user) {
    document.getElementById('modalUserName').innerHTML = `
        <div class='modal-header'>
            <span>${user.name}</span>
            ${user.role ? `<span class='role-badge ${user.role === 'Администратор' ? 'admin' : user.role === 'Сотрудник' ? 'staff' : 'user'}'>${user.role}</span>` : ''}
        </div>
    `;
    document.getElementById('userInfoModal').style.display = 'flex';
    document.getElementById('modalUserInfo').innerHTML = `
        ${user.email ? `<div class='user-modal-email'>${user.email}</div>` : ''}
        <div class='user-modal-dates'>
            <span><svg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'><rect x='3' y='4' width='18' height='18' rx='2' stroke-width='2'/><path d='M16 2v4M8 2v4M3 10h18' stroke-width='2'/></svg> ${user.reg || '—'}</span>
            <span><svg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'><circle cx='12' cy='12' r='10' stroke-width='2'/><path d='M12 6v6l4 2' stroke-width='2'/></svg> ${user.act || '—'}</span>
        </div>
    `;
}

function closeUserModal() {
    document.getElementById('userInfoModal').style.display = 'none';
}

// Закрытие по клику на фон
const userModal = document.getElementById('userInfoModal');
if (userModal) {
    userModal.addEventListener('click', function(event) {
        if (event.target === this) {
            closeUserModal();
        }
    });
}

const projectColors = [
  '#7c3aed', // фиолетовый
  '#2563eb', // синий
  '#059669', // зелёный
  '#eab308', // жёлтый
  '#f97316', // оранжевый
  '#ef4444', // красный
  '#14b8a6', // бирюзовый
  '#a21caf', // пурпурный
  '#0ea5e9', // голубой
  '#b91c1c'  // бордовый
];
const projectColorsDark = [
  '#a78bfa', '#60a5fa', '#34d399', '#fde047', '#fdba74', '#f87171', '#2dd4bf', '#e879f9', '#38bdf8', '#fca5a5'
];
function getProjectColor(name) {
  if (!name || name === '—') return '#e5e7eb';
  let hash = 0;
  for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
  const idx = Math.abs(hash) % projectColors.length;
  if (document.body.classList.contains('dark-theme')) return projectColorsDark[idx];
  return projectColors[idx];
}

// Обработка кнопки обновления кэша
const refreshBtn = document.getElementById('refreshCacheBtn');
const refreshStatus = document.getElementById('refreshCacheStatus');
const refreshIcon = document.querySelector('.refresh-icon');
const refreshSpinner = document.querySelector('.refresh-spinner');
const refreshBtnText = document.getElementById('refreshBtnText');

if (refreshBtn) {
    refreshBtn.addEventListener('click', function() {
        refreshBtn.disabled = true;
        refreshIcon.classList.add('hidden');
        refreshSpinner.classList.add('visible');
        refreshBtnText.textContent = 'Обновление...';
        refreshStatus.textContent = '';

        fetch('/refresh-cache/', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
        })
        .then(resp => resp.json())
        .then(data => {
            refreshIcon.classList.remove('hidden');
            refreshSpinner.classList.remove('visible');
            refreshBtnText.textContent = 'Обновить кэш';
            
            if (data.status === 'success') {
                refreshStatus.textContent = 'Кэш успешно обновлён!';
                setTimeout(() => { refreshStatus.textContent = ''; }, 2000);
            } else {
                refreshStatus.textContent = 'Ошибка: ' + (data.message || 'Не удалось обновить кэш');
            }
        })
        .catch(() => {
            refreshIcon.classList.remove('hidden');
            refreshSpinner.classList.remove('visible');
            refreshBtnText.textContent = 'Обновить кэш';
            refreshStatus.textContent = 'Ошибка сети';
        })
        .finally(() => {
            refreshBtn.disabled = false;
        });
    });
}
</script>
{% endblock %}