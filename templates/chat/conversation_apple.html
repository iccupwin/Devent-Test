{% extends 'base_apple.html' %}
{% load static %}

{% block title %}Беседа с {{ conversation.ai_model.name }}{% endblock %}

{% block content %}
<div class="app-layout">
    <div class="sidebar">
        <button id="newChatButton" class="new-chat-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Новая беседа
        </button>
        
        <div class="conversations-list">
            {% for conv in conversations %}
            <a href="{% url 'chat:conversation' conversation_id=conv.id %}" class="conversation-item {% if conv.id == conversation.id %}active{% endif %}">
                {{ conv.title }}
            </a>
            {% endfor %}
        </div>
    </div>
    
    <div class="content">
        <div class="chat-container" data-conversation-id="{{ conversation.id }}">
            <div class="chat-header">
                <div class="model-selector">
                    <div class="model-select-wrapper">
                        <select id="aiModelSelect" class="model-select">
                            {% for model in ai_models %}
                            <option value="{{ model.id }}" {% if model.id == conversation.ai_model.id %}selected{% endif %}>
                                {{ model.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="model-select-arrow">▼</div>
                    </div>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                {% for message in messages %}
                <div class="message {{ message.role }}">
                    {% if message.role == 'assistant' %}
                    <div class="assistant-avatar">{{ message.ai_model_used.name|first|upper }}</div>
                    <div class="message-content-wrapper">
                    {% endif %}
                        <div class="message-role">
                            {% if message.role == 'user' %}
                            Вы
                            {% else %}
                            {{ message.ai_model_used.name }}
                            {% endif %}
                        </div>
                        <div class="message-content">{{ message.content }}</div>
                    {% if message.role == 'assistant' %}
                    </div>
                    {% endif %}
                </div>
                {% empty %}
                <div class="welcome-message">
                    <h1>Привет! Я {{ conversation.ai_model.name }}.</h1>
                    <p>Задайте мне вопрос, и я постараюсь помочь.</p>
                </div>
                {% endfor %}
            </div>
            
            <div class="chat-input-container">
                <form id="messageForm" class="message-form">
                    <textarea 
                        id="messageInput" 
                        class="message-input" 
                        placeholder="Введите сообщение..."
                        rows="1"
                        autocomplete="off"
                    ></textarea>
                    <button type="submit" class="send-button">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/chat.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const modelSelect = document.getElementById('aiModelSelect');
    const conversationId = document.querySelector('.chat-container').dataset.conversationId;
    
    modelSelect.addEventListener('change', function() {
        const selectedModelId = this.value;
        // Отправляем запрос на изменение модели
        fetch(`/chat/conversation/${conversationId}/change-model/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                model_id: selectedModelId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Обновляем имя модели в приветственном сообщении
                const welcomeMessage = document.querySelector('.welcome-message h1');
                if (welcomeMessage) {
                    welcomeMessage.textContent = `Привет! Я ${data.model_name}.`;
                }
                // Обновляем заголовок страницы
                document.title = `Беседа с ${data.model_name}`;
            }
        })
        .catch(error => console.error('Error:', error));
    });
    
    // Функция для получения CSRF токена
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}

{% block styles %}
<style>
.chat-header {
    padding: 15px 20px;
    border-bottom: 1px solid #e0e0e0;
    background: #f8f8f8;
    display: flex;
    justify-content: flex-start;
    align-items: center;
}

.model-selector {
    display: flex;
    align-items: center;
}

.model-select-wrapper {
    position: relative;
    display: inline-block;
}

.model-select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    padding: 8px 35px 8px 15px;
    border: 2px solid #0071e3;
    border-radius: 8px;
    background-color: white;
    color: #0071e3;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 180px;
}

.model-select-arrow {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #0071e3;
    pointer-events: none;
    font-size: 12px;
}

.model-select:hover {
    background-color: #f0f0f0;
    border-color: #005bb5;
}

.model-select:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.2);
}

.assistant-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: #0071e3;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 12px;
}
</style>
{% endblock %}