{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
<link rel="stylesheet" href="{% static 'admin/css/dashboard.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <h1>Аналитика моделей ИИ</h1>
    <p>Статистика за последние {{ period }}</p>

    <!-- Карточки с общей статистикой -->
    <div class="stats-cards">
        {% for model in models_data %}
        <div class="stats-card {% if not model.is_active %}inactive{% endif %}">
            <h3>{{ model.name }}</h3>
            <p class="model-type">{{ model.type }} ({{ model.version }})</p>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">Запросы</span>
                    <span class="stat-value">{{ model.usage }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Токены</span>
                    <span class="stat-value">{{ model.tokens }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Среднее время ответа</span>
                    <span class="stat-value">{{ model.avg_response_time }} сек</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Ошибки</span>
                    <span class="stat-value">{{ model.error_rate }}%</span>
                </div>
            </div>
            <div class="model-status">
                {% if model.is_active %}
                <span class="status-badge active">Активна</span>
                {% else %}
                <span class="status-badge inactive">Неактивна</span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Графики -->
    <div class="charts-container">
        <!-- График запросов -->
        <div class="chart-wrapper">
            <h2>Количество запросов</h2>
            <canvas id="requestsChart"></canvas>
        </div>

        <!-- График использования токенов -->
        <div class="chart-wrapper">
            <h2>Использование токенов</h2>
            <canvas id="tokensChart"></canvas>
        </div>

        <!-- График времени ответа -->
        <div class="chart-wrapper">
            <h2>Среднее время ответа</h2>
            <canvas id="responseTimeChart"></canvas>
        </div>
    </div>
</div>

{% endblock %}

{% block extrajs %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    // Данные для графиков
    const chartData = {{ chart_data|safe }};
    
    // Цвета для моделей
    const modelColors = {
        'Claude 3 Opus': {
            primary: 'rgba(54, 162, 235, 0.7)',
            border: 'rgba(54, 162, 235, 1)'
        },
        'GPT-4 Turbo': {
            primary: 'rgba(75, 192, 192, 0.7)',
            border: 'rgba(75, 192, 192, 1)'
        },
        'Gemini Pro': {
            primary: 'rgba(255, 99, 132, 0.7)',
            border: 'rgba(255, 99, 132, 1)'
        }
    };

    // Функция для создания датасетов
    function createDatasets(data, valueKey) {
        return Object.keys(data.datasets).map(modelName => ({
            label: modelName,
            data: data.datasets[modelName][valueKey],
            backgroundColor: modelColors[modelName]?.primary || 'rgba(128, 128, 128, 0.7)',
            borderColor: modelColors[modelName]?.border || 'rgba(128, 128, 128, 1)',
            borderWidth: 1
        }));
    }

    // График запросов
    new Chart(document.getElementById('requestsChart'), {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: createDatasets(chartData, 'requests')
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // График токенов
    new Chart(document.getElementById('tokensChart'), {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: createDatasets(chartData, 'tokens')
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // График времени ответа
    new Chart(document.getElementById('responseTimeChart'), {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: createDatasets(chartData, 'response_times')
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>

<style>
    .content-wrapper {
        padding: 20px;
    }

    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stats-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .stats-card.inactive {
        opacity: 0.7;
    }

    .model-type {
        color: #666;
        margin-bottom: 15px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }

    .stat-item {
        display: flex;
        flex-direction: column;
    }

    .stat-label {
        font-size: 0.9em;
        color: #666;
    }

    .stat-value {
        font-size: 1.2em;
        font-weight: bold;
    }

    .model-status {
        margin-top: 15px;
        text-align: right;
    }

    .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.9em;
    }

    .status-badge.active {
        background: #e3fcef;
        color: #0a6c3b;
    }

    .status-badge.inactive {
        background: #fbe9e7;
        color: #c62828;
    }

    .charts-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }

    .chart-wrapper {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .chart-wrapper h2 {
        margin-bottom: 15px;
        font-size: 1.2em;
        color: #333;
    }
</style>
{% endblock %} 